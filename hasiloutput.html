<!DOCTYPE html>
<html lang="id" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Hasil - SPK Jurusan SMA dan SMK</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/style.css" />
    <script src="assets/js/theme.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="index.html">
          <i class="fas fa-graduation-cap me-2"></i>
          Sistem Pendukung Keputusan
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="index.html">
                <i class="fas fa-home me-1"></i> Beranda
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="konsultasi.html">
                <i class="fas fa-comments me-1"></i> Konsultasi
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="jurusan.html">
                <i class="fas fa-book me-1"></i> Jurusan
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="tentang.html">
                <i class="fas fa-info-circle me-1"></i> Tentang
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="hasiloutput.html">
                <i class="fas fa-chart-bar me-1"></i> Data Hasil
              </a>
            </li>
            <li class="nav-item ms-3">
              <button
                id="theme-toggle"
                class="btn btn-link nav-link p-0"
                aria-label="Toggle theme"
              >
                <i class="fas fa-moon"></i>
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid px-2 px-md-3 py-2">
      <div class="row justify-content-center">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white py-3">
              <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Data Hasil Konsultasi</h4>
                <div>
                  <a href="konsultasi.html" class="btn btn-light btn-sm">
                    <i class="fas fa-plus me-1"></i>Konsultasi Baru
                  </a>
                </div>
              </div>
            </div>

            <div class="card-body p-0">
              <!-- Stats Summary -->
              <div class="bg-light p-3 border-bottom">
                <div class="row g-3" id="stats-summary">
                  <div class="col-12 col-md-3">
                    <div class="card bg-primary text-white">
                      <div class="card-body p-3">
                        <h6 class="mb-1">Total Konsultasi</h6>
                        <h3 class="mb-0" id="total-konsultasi">0</h3>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-3">
                    <div class="card bg-success text-white">
                      <div class="card-body p-3">
                        <h6 class="mb-1">Rekomendasi SMA</h6>
                        <h3 class="mb-0" id="total-sma">0</h3>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-3">
                    <div class="card bg-info text-white">
                      <div class="card-body p-3">
                        <h6 class="mb-1">Rekomendasi SMK</h6>
                        <h3 class="mb-0" id="total-smk">0</h3>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-3">
                    <div class="card bg-warning text-dark">
                      <div class="card-body p-3">
                        <h6 class="mb-1">Konsultasi Hari Ini</h6>
                        <h3 class="mb-0" id="total-today">0</h3>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Filter Section -->
              <div class="p-3 border-bottom">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input
                      type="text"
                      class="form-control form-control-sm"
                      id="searchInput"
                      placeholder="Cari nama/NISN..."
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <select
                      class="form-select form-select-sm"
                      id="filterSekolah"
                    >
                      <option value="">Semua Jenis Sekolah</option>
                      <option value="SMA">SMA</option>
                      <option value="SMK">SMK</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-3">
                    <select class="form-select form-select-sm" id="sortBy">
                      <option value="date_desc">Tanggal Terbaru</option>
                      <option value="date_asc">Tanggal Terlama</option>
                      <option value="name_asc">Nama A-Z</option>
                      <option value="name_desc">Nama Z-A</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Results Table -->
              <div class="table-responsive">
                <table
                  class="table table-hover table-striped align-middle mb-0"
                  id="resultsTable"
                >
                  <thead class="table-light">
                    <tr>
                      <th class="text-center" style="width: 50px">#</th>
                      <th class="text-center" style="width: 120px">Tanggal</th>
                      <th>Nama Siswa</th>
                      <th class="text-center">NISN</th>
                      <th>Sekolah</th>
                      <th>Kelas</th>
                      <th>Rekomendasi</th>
                      <th class="text-center" style="width: 100px">Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="resultsBody">
                    <!-- Data will be loaded here -->
                  </tbody>
                </table>
              </div>

              <!-- Empty State -->
              <div
                id="emptyState"
                class="text-center p-4"
                style="display: none"
              >
                <div class="text-muted mb-3">
                  <i class="fas fa-inbox fa-3x"></i>
                </div>
                <h5>Belum Ada Data</h5>
                <p class="mb-0">Belum ada hasil konsultasi yang tersimpan.</p>
                <div class="mt-3">
                  <a href="konsultasi.html" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Mulai Konsultasi
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function loadHasilKonsultasi() {
        try {
          const response = await fetch("/api/hasil");
          const data = await response.json();
          updateStats(data);
          displayResults(data);
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("emptyState").style.display = "block";
        }
      }

      function updateStats(data) {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("total-konsultasi").textContent = data.length;
        document.getElementById("total-sma").textContent = data.filter(
          (h) => h.jenis_sekolah === "SMA"
        ).length;
        document.getElementById("total-smk").textContent = data.filter(
          (h) => h.jenis_sekolah === "SMK"
        ).length;
        document.getElementById("total-today").textContent = data.filter((h) =>
          h.tanggal.startsWith(today)
        ).length;
      }

      function displayResults(data) {
        const tbody = document.getElementById("resultsBody");
        const emptyState = document.getElementById("emptyState");

        if (data.length === 0) {
          tbody.innerHTML = "";
          emptyState.style.display = "block";
          return;
        }

        emptyState.style.display = "none";
        tbody.innerHTML = data
          .map(
            (h, index) => `
                <tr>
                    <td class="text-center">${index + 1}</td>
                    <td class="text-center small">
                        <div>${new Date(h.tanggal).toLocaleDateString(
                          "id-ID"
                        )}</div>
                        <small class="text-muted">${new Date(
                          h.tanggal
                        ).toLocaleTimeString("id-ID")}</small>
                    </td>
                    <td>
                        <div class="fw-bold">${h.nama_lengkap}</div>
                    </td>
                    <td class="text-center">${h.nisn}</td>
                    <td>${h.sekolah}</td>
                    <td>${h.kelas}</td>
                    <td>
                        <div class="d-flex flex-column gap-1">
                            <span class="badge bg-primary">${
                              h.nama_jurusan
                            }</span>
                            <span class="badge bg-secondary">${
                              h.jenis_sekolah
                            }</span>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <a href="hasil.html?id=${
                              h.id_siswa
                            }" class="btn btn-info" title="Lihat Detail">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button type="button" class="btn btn-primary" title="Cetak Hasil" onclick="printHasil(${
                              h.id_siswa
                            })">
                                <i class="fas fa-print"></i>
                            </button>
                            <button type="button" class="btn btn-danger" title="Hapus Data" onclick="deleteHasil(${
                              h.id_siswa
                            }, '${h.nama_lengkap}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      function filterAndSortResults() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const selectedSekolah = document.getElementById("filterSekolah").value;
        const sortByValue = document.getElementById("sortBy").value;

        loadHasilKonsultasi().then((data) => {
          let filtered = data;

          // Filter by search term
          if (searchTerm) {
            filtered = filtered.filter(
              (h) =>
                h.nama_lengkap.toLowerCase().includes(searchTerm) ||
                h.nisn.toLowerCase().includes(searchTerm)
            );
          }

          // Filter by school type
          if (selectedSekolah) {
            filtered = filtered.filter(
              (h) => h.jenis_sekolah === selectedSekolah
            );
          }

          // Sort results
          filtered.sort((a, b) => {
            switch (sortByValue) {
              case "date_desc":
                return new Date(b.tanggal) - new Date(a.tanggal);
              case "date_asc":
                return new Date(a.tanggal) - new Date(b.tanggal);
              case "name_asc":
                return a.nama_lengkap.localeCompare(b.nama_lengkap);
              case "name_desc":
                return b.nama_lengkap.localeCompare(a.nama_lengkap);
            }
          });

          displayResults(filtered);
        });
      }

      function printHasil(id) {
        window.open(`/api/cetak?id=${id}`, "_blank");
      }

      async function deleteHasil(id, nama) {
        if (
          confirm(
            `Apakah Anda yakin ingin menghapus hasil konsultasi untuk siswa ${nama}?`
          )
        ) {
          try {
            const response = await fetch(`/api/hasil/${id}`, {
              method: "DELETE",
            });
            if (response.ok) {
              alert("Data hasil konsultasi berhasil dihapus");
              loadHasilKonsultasi();
            }
          } catch (error) {
            console.error("Error deleting data:", error);
            alert("Gagal menghapus data");
          }
        }
      }

      // Add event listeners
      document.addEventListener("DOMContentLoaded", () => {
        loadHasilKonsultasi();

        document
          .getElementById("searchInput")
          .addEventListener("input", filterAndSortResults);
        document
          .getElementById("filterSekolah")
          .addEventListener("change", filterAndSortResults);
        document
          .getElementById("sortBy")
          .addEventListener("change", filterAndSortResults);
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
